--[[
    BladeHub: Ultimate Edition
    提供されたソースコードの全ロジックを統合し、日本語化・UI刷新を行った完全版。
]]

local Rayfield = loadstring(game:HttpGet('https://sirius.menu/rayfield'))()

-- 高速化用サービス定義
local Players = cloneref(game:GetService("Players"))
local RunService = cloneref(game:GetService("RunService"))
local UserInputService = cloneref(game:GetService("UserInputService"))
local VirtualInputManager = cloneref(game:GetService("VirtualInputManager"))
local ReplicatedStorage = cloneref(game:GetService("ReplicatedStorage"))
local TweenService = cloneref(game:GetService("TweenService"))
local Stats = cloneref(game:GetService("Stats"))
local Debris = cloneref(game:GetService("Debris"))

local Player = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- 設定・状態管理テーブル
local BladeHub = {
    AutoParry = false,
    SpamParry = false,
    LobbyParry = false,
    ManualSpam = false,
    TriggerBot = false,
    
    -- 計算パラメータ (元コードより移植)
    ParryAccuracy = 100,
    SpeedMultiplier = 1.1,
    ParryThreshold = 2.5,
    SelectedParryType = "Camera",
    
    -- ビジュアル・その他
    Visuals = {
        HitSound = false,
        Headless = false,
        Korblox = false,
        FOV = 70,
        CameraEnabled = false
    },
    
    -- 移動
    Movement = {
        Fly = false,
        FlySpeed = 50,
        Spinbot = false,
        SpinSpeed = 1,
        Strafe = false,
        WalkSpeed = 36
    }
}

-- 内部変数
local Parries = 0
local LastParry = 0
local OldPos = Vector3.zero
local Connections = {}

-- ウィンドウ作成
local Window = Rayfield:CreateWindow({
    Name = "BladeHub | Ultimate (JP)",
    LoadingTitle = "システム構築中...",
    LoadingSubtitle = "Logic: Provided Source",
    ConfigurationSaving = {
        Enabled = true,
        FolderName = "BladeHubUltimate",
        FileName = "Config"
    },
    KeySystem = false,
})

-- [[ ロジック・計算関数群 (元コード移植) ]] --

local Auto_Parry = {}

function Auto_Parry.Get_Ball()
    for _, Ball in pairs(workspace.Balls:GetChildren()) do
        if Ball:GetAttribute("realBall") or Ball:FindFirstChild("zoomies") then
            return Ball
        end
    end
    -- 予備: 属性がない場合
    for _, Ball in pairs(workspace.Balls:GetChildren()) do
        if Ball:IsA("BasePart") and Ball.Transparency < 1 then
            return Ball
        end
    end
    return nil
end

function Auto_Parry.Lobby_Balls()
    for _, Instance in pairs(workspace.TrainingBalls:GetChildren()) do
        if Instance:GetAttribute("realBall") then return Instance end
    end
end

function Auto_Parry.Get_Closest_Player()
    local Max_Distance = math.huge
    local Closest = nil
    for _, Entity in pairs(workspace.Alive:GetChildren()) do
        if Entity ~= Player.Character and Entity:FindFirstChild("HumanoidRootPart") then
            local Dist = (Player.Character.HumanoidRootPart.Position - Entity.HumanoidRootPart.Position).Magnitude
            if Dist < Max_Distance then
                Max_Distance = Dist
                Closest = Entity
            end
        end
    end
    return Closest
end

-- カーブ検知ロジック (移植)
local Lerp_Radians = 0
function Auto_Parry.Is_Curved(Ball)
    if not Ball then return false end
    local Zoomies = Ball:FindFirstChild('zoomies')
    if not Zoomies then return false end

    local Velocity = Zoomies.VectorVelocity
    local Ball_Direction = Velocity.Unit
    local Direction = (Player.Character.PrimaryPart.Position - Ball.Position).Unit
    local Dot = Direction:Dot(Ball_Direction)
    local Speed = Velocity.Magnitude
    
    local Pings = Stats.Network.ServerStatsItem['Data Ping']:GetValue()
    local Dot_Threshold = 0.5 - (Pings / 1000)
    
    -- 簡易化された判定
    return Dot < Dot_Threshold
end

-- クリック実行 (スマホ対応版)
local function Click()
    local Center = Camera.ViewportSize / 2
    VirtualInputManager:SendMouseButtonEvent(Center.X, Center.Y, 0, true, game, 1)
    VirtualInputManager:SendMouseButtonEvent(Center.X, Center.Y, 0, false, game, 1)
    -- バックアップキー入力
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.F, false, game)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.F, false, game)
end

-- パリー実行 (方向指定対応)
local function PerformParry(Type)
    -- カメラ操作が必要な場合はここでCFrameをいじる (今回はクリック主体で実装)
    if Type == "Backwards" then
        Camera.CFrame = Camera.CFrame * CFrame.Angles(0, math.rad(180), 0)
    elseif Type == "Random" then
        Camera.CFrame = Camera.CFrame * CFrame.Angles(math.rad(math.random(-180,180)), math.rad(math.random(-180,180)), 0)
    end
    
    Click()
    Parries = Parries + 1
    
    -- カウンターリセット
    task.delay(0.5, function() 
        if Parries > 0 then Parries = Parries - 1 end 
    end)
    
    -- カメラを戻す処理が必要ならここに追加
end

-- [[ UI構築 ]] --

-- 1. 戦闘タブ
local CombatTab = Window:CreateTab("戦闘 (Combat)", 4483362458)

CombatTab:CreateSection("オートパリー設定")

CombatTab:CreateToggle({
    Name = "オートパリー有効化",
    CurrentValue = false,
    Flag = "AutoParry",
    Callback = function(Value)
        BladeHub.AutoParry = Value
    end,
})

CombatTab:CreateSlider({
    Name = "パリー精度 (距離補正)",
    Range = {1, 100},
    Increment = 1,
    CurrentValue = 100,
    Callback = function(Value)
        -- 元コードの計算式を維持
        BladeHub.SpeedMultiplier = 0.7 + (Value - 1) * (0.35 / 99)
    end,
})

CombatTab:CreateDropdown({
    Name = "パリー方向 / モード",
    Options = {"Camera", "Random", "Backwards", "Straight", "Left", "Right"},
    CurrentOption = {"Camera"},
    Callback = function(Option)
        BladeHub.SelectedParryType = Option[1]
    end,
})

CombatTab:CreateSection("スパム・特殊")

CombatTab:CreateToggle({
    Name = "オートスパム (自動連打)",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.SpamParry = Value
    end,
})

CombatTab:CreateSlider({
    Name = "スパム閾値 (連打開始判定)",
    Range = {1, 3},
    Increment = 0.1,
    CurrentValue = 2.5,
    Callback = function(Value)
        BladeHub.ParryThreshold = Value
    end,
})

CombatTab:CreateToggle({
    Name = "トリガーボット (照準時反応)",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.TriggerBot = Value
    end,
})

CombatTab:CreateToggle({
    Name = "ロビー用オートパリー (練習)",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.LobbyParry = Value
    end,
})

-- 2. プレイヤー・移動タブ
local PlayerTab = Window:CreateTab("プレイヤー", 4483362458)

PlayerTab:CreateSection("移動設定")

PlayerTab:CreateToggle({
    Name = "速度変更 (Strafe)",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.Movement.Strafe = Value
    end,
})

PlayerTab:CreateSlider({
    Name = "歩行速度 (WalkSpeed)",
    Range = {16, 200},
    Increment = 1,
    CurrentValue = 36,
    Callback = function(Value)
        BladeHub.Movement.WalkSpeed = Value
    end,
})

PlayerTab:CreateToggle({
    Name = "スピンボット (回転)",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.Movement.Spinbot = Value
    end,
})

PlayerTab:CreateSlider({
    Name = "回転速度",
    Range = {1, 100},
    Increment = 1,
    CurrentValue = 10,
    Callback = function(Value)
        BladeHub.Movement.SpinSpeed = Value
    end,
})

PlayerTab:CreateSection("飛行 (Fly)")

PlayerTab:CreateToggle({
    Name = "フライ有効化",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.Movement.Fly = Value
    end,
})

PlayerTab:CreateSlider({
    Name = "飛行速度",
    Range = {10, 150},
    Increment = 1,
    CurrentValue = 50,
    Callback = function(Value)
        BladeHub.Movement.FlySpeed = Value
    end,
})

-- 3. ビジュアルタブ
local VisualTab = Window:CreateTab("ビジュアル", 4483362458)

VisualTab:CreateSection("コスメティック")

VisualTab:CreateToggle({
    Name = "ヘッドレス (頭透明化)",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.Visuals.Headless = Value
        if Player.Character and Player.Character:FindFirstChild("Head") then
            Player.Character.Head.Transparency = Value and 1 or 0
        end
    end,
})

VisualTab:CreateToggle({
    Name = "Korblox (右足透明化)",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.Visuals.Korblox = Value
        if Player.Character and Player.Character:FindFirstChild("RightLeg") then
            Player.Character.RightLeg.Transparency = Value and 1 or 0
        end
    end,
})

VisualTab:CreateSection("その他")

VisualTab:CreateToggle({
    Name = "ヒットサウンド有効化",
    CurrentValue = false,
    Callback = function(Value)
        BladeHub.Visuals.HitSound = Value
    end,
})

local HitSounds = {
    ["Rust"] = "rbxassetid://138750331387064",
    ["Neverlose"] = "rbxassetid://110168723447153",
    ["Skeet"] = "rbxassetid://6607204501",
    ["Bubble"] = "rbxassetid://6534947588"
}
local SelectedSound = HitSounds["Rust"]

VisualTab:CreateDropdown({
    Name = "サウンド選択",
    Options = {"Rust", "Neverlose", "Skeet", "Bubble"},
    CurrentOption = {"Rust"},
    Callback = function(Option)
        SelectedSound = HitSounds[Option[1]]
    end,
})

-- [[ メインループ処理 ]] --

-- オートパリー & スパムループ
RunService.PreSimulation:Connect(function()
    if not Player.Character then return end
    
    -- 1. ロビーモード
    if BladeHub.LobbyParry then
        local Ball = Auto_Parry.Lobby_Balls()
        if Ball and Ball:GetAttribute("target") == Player.Name then
            local Dist = (Player.Character.HumanoidRootPart.Position - Ball.Position).Magnitude
            if Dist < 20 then PerformParry(BladeHub.SelectedParryType) end
        end
    end

    -- 2. メインオートパリー
    if BladeHub.AutoParry then
        local Ball = Auto_Parry.Get_Ball()
        if not Ball then return end

        local Zoomies = Ball:FindFirstChild('zoomies')
        local Velocity = Zoomies and Zoomies.VectorVelocity or Ball.AssemblyLinearVelocity
        local Speed = Velocity.Magnitude
        local Distance = (Player.Character.HumanoidRootPart.Position - Ball.Position).Magnitude
        
        -- カーブ考慮
        local IsCurved = Auto_Parry.Is_Curved(Ball)
        
        -- ピン取得
        local Ping = Stats.Network.ServerStatsItem['Data Ping']:GetValue() / 10
        local Ping_Threshold = math.clamp(Ping / 10, 5, 17)
        
        -- 元コードの計算式再現
        local cappedSpeedDiff = math.min(math.max(Speed - 9.5, 0), 650)
        local speed_divisor_base = 2.4 + cappedSpeedDiff * 0.002
        local speed_divisor = speed_divisor_base * BladeHub.SpeedMultiplier
        
        local Parry_Accuracy = Ping_Threshold + math.max(Speed / speed_divisor, 9.5)

        -- ターゲット判定
        if Ball:GetAttribute('target') == Player.Name then
            -- 距離チェック
            if Distance <= Parry_Accuracy then
                PerformParry(BladeHub.SelectedParryType)
            end
            
            -- インフィニティや能力の考慮が必要ならここに追加
        end

        -- スパム処理 (トリガーボット・スパム)
        if BladeHub.SpamParry or BladeHub.TriggerBot then
             -- 近距離スパムロジック
            local SpamDist = Ping + math.min(Speed / 6, 95)
            if Distance <= SpamDist and (Ball:GetAttribute('target') == Player.Name or BladeHub.TriggerBot) then
                 -- スパム発動条件
                 if Parries > BladeHub.ParryThreshold or Distance < 15 then
                     Click()
                 end
            end
        end
    end
end)

-- 移動系ループ (Strafe / Spin)
RunService.Heartbeat:Connect(function()
    if not Player.Character or not Player.Character:FindFirstChild("Humanoid") then return end
    
    -- Strafe (速度)
    if BladeHub.Movement.Strafe then
        Player.Character.Humanoid.WalkSpeed = BladeHub.Movement.WalkSpeed
    end
    
    -- Spinbot
    if BladeHub.Movement.Spinbot and Player.Character:FindFirstChild("HumanoidRootPart") then
        Player.Character.HumanoidRootPart.CFrame = Player.Character.HumanoidRootPart.CFrame * CFrame.Angles(0, math.rad(BladeHub.Movement.SpinSpeed * 10), 0)
    end
end)

-- フライ機能 (BodyVelocity)
local BV, BG
RunService.RenderStepped:Connect(function()
    if BladeHub.Movement.Fly and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
        local HRP = Player.Character.HumanoidRootPart
        if not HRP:FindFirstChild("BladeHubFly") then
            BV = Instance.new("BodyVelocity")
            BV.Name = "BladeHubFly"
            BV.MaxForce = Vector3.new(1e5, 1e5, 1e5)
            BV.Parent = HRP
            
            BG = Instance.new("BodyGyro")
            BG.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
            BG.P = 9000
            BG.Parent = HRP
        end
        
        BV.Velocity = Vector3.zero
        local CamCF = Camera.CFrame
        
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then
            BV.Velocity = BV.Velocity + CamCF.LookVector * BladeHub.Movement.FlySpeed
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then
            BV.Velocity = BV.Velocity - CamCF.LookVector * BladeHub.Movement.FlySpeed
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then
            BV.Velocity = BV.Velocity - CamCF.RightVector * BladeHub.Movement.FlySpeed
        end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then
            BV.Velocity = BV.Velocity + CamCF.RightVector * BladeHub.Movement.FlySpeed
        end
        
        BG.CFrame = CamCF
    else
        if Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
             local fly = Player.Character.HumanoidRootPart:FindFirstChild("BladeHubFly")
             if fly then fly:Destroy() end
             local gyro = Player.Character.HumanoidRootPart:FindFirstChild("BodyGyro")
             if gyro then gyro:Destroy() end
        end
    end
end)

-- ヒットサウンド処理
ReplicatedStorage.Remotes.ParrySuccess.OnClientEvent:Connect(function()
    if BladeHub.Visuals.HitSound then
        local Sound = Instance.new("Sound")
        Sound.SoundId = SelectedSound
        Sound.Volume = 5
        Sound.Parent = workspace
        Sound:Play()
        Debris:AddItem(Sound, 2)
    end
end)

Rayfield:Notify({
    Title = "BladeHub Ultimate",
    Content = "全機能搭載・日本語化完了。",
    Duration = 5,
    Image = 4483362458,
})
