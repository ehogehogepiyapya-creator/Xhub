--[[
    LuaHub v7: Universe (Bug Fix & Feature Packed)
    Fixes:
    - Line 1 Nil Error (Changed Lib Source)
    - Infinite Yield "Torso" (Added R15 Support)
    - Mobile Controls Optimized
]]

-- 1. å®‰å…¨ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ (ã‚¨ãƒ©ãƒ¼å›é¿)
local success, OrionLib = pcall(function()
    return loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Orion/main/source"))()
end)

if not success or not OrionLib then
    -- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒªãƒ³ã‚¯
    OrionLib = loadstring(game:HttpGet("https://raw.githubusercontent.com/july/Orion/main/source"))()
end

-- ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local task = task

local localPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- --- [è¨­å®šå¤‰æ•°] ---
local ToyName = "FoodHamburger"
local EggName = localPlayer.Name
local SpawnTimeout = 1.0

-- çŠ¶æ…‹ãƒ•ãƒ©ã‚°
local TrainControl = false
local TrainNoclipEnabled = false
local TrainSpinEnabled = false
local PlayerFlyEnabled = false
local Noclip = false
local InfJumpEnabled = false
local ESPEnabled = false
local TracerEnabled = false
local NameESPEnabled = false
local AimbotEnabled = false
local HitboxExpanded = false
local WalkOnWaterEnabled = false
local AntiRagdollEnabled = false
local LoopFling = false

-- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
local FLY_SPEED = 20
local SPIN_SPEED = 5
local PlayerFlySpeed = 50
local SelectedPlayer = nil

-- ç‰©ç†åˆ¶å¾¡ç”¨
local BV, BG
local PlayerBV
local VFlyEnabled = false
local TargetPart = nil

-- --- [é‡è¦] R15/R6 ä¸¡å¯¾å¿œã®ãƒ‘ãƒ¼ãƒ„å–å¾—é–¢æ•° (ãƒã‚°ä¿®æ­£ã®è¦) ---
local function GetRoot(char)
    if not char then return nil end
    return char:FindFirstChild("HumanoidRootPart") or char:FindFirstChild("Torso") or char:FindFirstChild("UpperTorso")
end

----------------------------------------------------------
-- [Core] åˆ—è»Š & Toy ãƒ­ã‚¸ãƒƒã‚¯ (Yukimi Engine Fixed)
----------------------------------------------------------
local function getToyInFolder()
    local folder = Workspace:FindFirstChild(localPlayer.Name .. "SpawnedInToys")
    return folder and folder:FindFirstChild(ToyName) or nil
end

local function spawnToy(targetCFrame)
    local menu = ReplicatedStorage:FindFirstChild("MenuToys")
    local spawnRF = menu and menu:FindFirstChild("SpawnToyRemoteFunction")
    if not spawnRF then return nil end
    pcall(function() spawnRF:InvokeServer(ToyName, targetCFrame, Vector3.new(0, 0, 0)) end)
    local start = tick()
    while tick() - start < SpawnTimeout do
        local toy = getToyInFolder()
        if toy then return toy end
        task.wait(0.05)
    end
    return nil
end

local function ensureToy()
    local toy = getToyInFolder()
    if toy then return toy end
    local char = localPlayer.Character
    local root = GetRoot(char)
    if root then return spawnToy(root.CFrame * CFrame.new(0, 3, 0)) end
    return nil
end

local function getTrainSeat()
    -- éšå±¤ãŒå¤‰ã‚ã£ã¦ã‚‚æ¢ã›ã‚‹ã‚ˆã†ã«å†å¸°æ¤œç´¢ã«å¤‰æ›´
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("Seat") or obj:IsA("VehicleSeat") then
            if obj.Parent and obj.Parent.Name == "ObjectModel" and obj:FindFirstAncestor("Train") then
                return obj
            end
        end
    end
    return nil
end

local function sitTrain()
    local char = localPlayer.Character
    local hum = char and char:FindFirstChildOfClass("Humanoid")
    local seat = getTrainSeat()
    if hum and seat then pcall(function() seat:Sit(hum) end) end
end

local function startLoop()
    task.spawn(function()
        while TrainControl do
            local char = localPlayer.Character
            local root = GetRoot(char)
            local egg = Workspace:FindFirstChild(EggName)
            if root and egg then
                local toy = ensureToy()
                if toy and toy.Parent then
                    -- ã‚¢ã‚¤ãƒ†ãƒ æ“ä½œãƒ­ã‚¸ãƒƒã‚¯
                    local menu = ReplicatedStorage:FindFirstChild("MenuToys")
                    local holdFn = (toy:FindFirstChild("HoldPart") and toy.HoldPart:FindFirstChild("HoldItemRemoteFunction")) or (menu and menu:FindFirstChild("HoldItemRemoteFunction"))
                    if holdFn then pcall(function() holdFn:InvokeServer(toy, egg) end) end
                    task.wait(0.03)
                    local dropFn = (toy:FindFirstChild("HoldPart") and toy.HoldPart:FindFirstChild("DropItemRemoteFunction")) or (menu and menu:FindFirstChild("DropItemRemoteFunction"))
                    if dropFn then pcall(function() dropFn:InvokeServer(toy, root.CFrame * CFrame.new(0, 3, 0), Vector3.new(0, -6.55, 0)) end) end
                end
            end
            task.wait(0.01)
        end
    end)
end

-- åˆ—è»Šé£›è¡Œ & ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é£›è¡Œå…±é€šé–¢æ•°
local function GetMoveDir()
    local cam = Workspace.CurrentCamera
    local dir = Vector3.zero
    
    -- PC/Mobileä¸¡å¯¾å¿œã®å…¥åŠ›æ¤œçŸ¥
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then dir = dir + cam.CFrame.LookVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then dir = dir - cam.CFrame.LookVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then dir = dir - cam.CFrame.RightVector end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then dir = dir + cam.CFrame.RightVector end
    
    -- ã‚¹ãƒãƒ›ã®ã‚¿ãƒƒãƒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å¯¾å¿œ (ControlModuleãƒ•ãƒƒã‚¯)
    local playerModule = localPlayer:FindFirstChild("PlayerScripts") and localPlayer.PlayerScripts:FindFirstChild("PlayerModule")
    if playerModule then
        local controlModule = require(playerModule:WaitForChild("ControlModule"))
        local moveVector = controlModule:GetMoveVector()
        if moveVector.Magnitude > 0 then
            dir = cam.CFrame.RightVector * moveVector.X + cam.CFrame.LookVector * -moveVector.Z
        end
    end
    
    if dir.Magnitude > 0 then dir = dir.Unit end
    return dir
end

-- åˆ—è»Šé£›è¡Œé–‹å§‹
local function StartTrainFly(seat)
    if VFlyEnabled then return end
    local part = seat
    if part.AssemblyRootPart then part = part.AssemblyRootPart end
    
    BV = Instance.new("BodyVelocity")
    BV.MaxForce = Vector3.new(1e9, 1e9, 1e9)
    BV.Velocity = Vector3.zero
    BV.Parent = part
    
    BG = Instance.new("BodyGyro")
    BG.MaxTorque = Vector3.new(1e9, 1e9, 1e9)
    BG.P = 10000
    BG.CFrame = part.CFrame
    BG.Parent = part
    
    TargetPart = part
    VFlyEnabled = true
end

local function StopTrainFly()
    VFlyEnabled = false
    if BV then BV:Destroy() BV = nil end
    if BG then BG:Destroy() BG = nil end
    TargetPart = nil
end

----------------------------------------------------------
-- [System] UI Construction (Orion)
----------------------------------------------------------
local Window = OrionLib:MakeWindow({
    Name = "LuaHub v7: Universe",
    HidePremium = true,
    SaveConfig = true,
    ConfigFolder = "LuaHubV7",
    IntroText = "Fixed & Enhanced",
    IntroIcon = "rbxassetid://4483345998"
})

-- === Tab 1: åˆ—è»Šåˆ¶å¾¡ (Train) ===
local TrainTab = Window:MakeTab({ Name = "ğŸš„ åˆ—è»Š", Icon = "rbxassetid://4483345998" })

TrainTab:AddToggle({
    Name = "åˆ—è»Šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é–‹å§‹",
    Default = false,
    Callback = function(v)
        TrainControl = v
        if v then
            startLoop()
            sitTrain()
            -- å°‘ã—å¾…ã£ã¦ã‹ã‚‰é£›è¡Œé–‹å§‹
            task.delay(1, function()
                local seat = getTrainSeat()
                if seat and seat.Occupant == localPlayer.Character.Humanoid then
                    StartTrainFly(seat)
                end
            end)
        else
            StopTrainFly()
        end
    end
})

TrainTab:AddSlider({ Name = "é£›è¡Œé€Ÿåº¦", Min = 10, Max = 400, Default = 50, Increment = 1, Callback = function(v) FLY_SPEED = v end })
TrainTab:AddToggle({ Name = "å£æŠœã‘ (Train Noclip)", Default = false, Callback = function(v) TrainNoclipEnabled = v end })
TrainTab:AddToggle({ Name = "å›è»¢ (Spin)", Default = false, Callback = function(v) TrainSpinEnabled = v end })
TrainTab:AddButton({ Name = "åˆ—è»Šã¸TP", Callback = function() 
    local seat = getTrainSeat() 
    if seat and localPlayer.Character then 
        GetRoot(localPlayer.Character).CFrame = seat.CFrame + Vector3.new(0,5,0) 
    end 
end })

-- === Tab 2: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç§»å‹• (Movement) ===
local MoveTab = Window:MakeTab({ Name = "ğŸƒ ç§»å‹•", Icon = "rbxassetid://18624601543" })

MoveTab:AddToggle({
    Name = "Player Fly (å˜ä½“é£›è¡Œ)",
    Default = false,
    Callback = function(v)
        PlayerFlyEnabled = v
        if not v and PlayerBV then PlayerBV:Destroy() PlayerBV = nil end
    end
})

MoveTab:AddSlider({ Name = "æ­©è¡Œé€Ÿåº¦ (WalkSpeed)", Min = 16, Max = 300, Default = 16, Increment = 1, Callback = function(v) if localPlayer.Character then localPlayer.Character.Humanoid.WalkSpeed = v end end })
MoveTab:AddSlider({ Name = "ã‚¸ãƒ£ãƒ³ãƒ—åŠ› (JumpPower)", Min = 50, Max = 300, Default = 50, Increment = 1, Callback = function(v) if localPlayer.Character then localPlayer.Character.Humanoid.UseJumpPower = true localPlayer.Character.Humanoid.JumpPower = v end end })
MoveTab:AddToggle({ Name = "ç„¡é™ã‚¸ãƒ£ãƒ³ãƒ—", Default = false, Callback = function(v) InfJumpEnabled = v end })
MoveTab:AddToggle({ Name = "å£æŠœã‘ (Noclip)", Default = false, Callback = function(v) Noclip = v end })

MoveTab:AddToggle({
    Name = "Walk on Water (æ°´ä¸Šæ­©è¡Œ)",
    Default = false,
    Callback = function(v)
        WalkOnWaterEnabled = v
        if v then
            Workspace.Terrain.WaterWaveSize = 0
            Workspace.Terrain.WaterReflectance = 0
            Workspace.Terrain.WaterTransparency = 0
            -- ç°¡æ˜“çš„ãªCollisionè¿½åŠ 
            local p = Instance.new("Part", Workspace)
            p.Name = "WaterPlatform"
            p.Size = Vector3.new(10000, 1, 10000)
            p.Position = Vector3.new(0, -3, 0) -- æ°´é¢ã®é«˜ã•ã«åˆã‚ã›ã¦èª¿æ•´
            p.Transparency = 1
            p.Anchored = true
        else
            if Workspace:FindFirstChild("WaterPlatform") then Workspace.WaterPlatform:Destroy() end
        end
    end
})

MoveTab:AddToggle({
    Name = "Anti-Ragdoll (è»¢å€’é˜²æ­¢)",
    Default = false,
    Callback = function(v)
        AntiRagdollEnabled = v
        if v then
            localPlayer.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
            localPlayer.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
        else
            localPlayer.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, true)
            localPlayer.Character.Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, true)
        end
    end
})

-- === Tab 3: æˆ¦é—˜ (Combat) ===
local CombatTab = Window:MakeTab({ Name = "âš”ï¸ æˆ¦é—˜", Icon = "rbxassetid://18624604880" })

local PlayerList = {}
local function UpdatePlayers()
    PlayerList = {}
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= localPlayer then table.insert(PlayerList, p.Name) end
    end
end
UpdatePlayers()

local Dropdown = CombatTab:AddDropdown({
    Name = "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸æŠ",
    Default = "",
    Options = PlayerList,
    Callback = function(v) SelectedPlayer = Players:FindFirstChild(v) end
})

CombatTab:AddButton({ Name = "ãƒªã‚¹ãƒˆæ›´æ–°", Callback = function() UpdatePlayers() Dropdown:Refresh(PlayerList, true) end })

CombatTab:AddButton({
    Name = "Fling (çªæ’ƒ)",
    Callback = function()
        if SelectedPlayer and SelectedPlayer.Character then
            local root = GetRoot(localPlayer.Character)
            local targetRoot = GetRoot(SelectedPlayer.Character)
            if root and targetRoot then
                local thrust = Instance.new('BodyThrust', root)
                thrust.Force = Vector3.new(9999,9999,9999)
                thrust.Name = "FlingForce"
                task.delay(0.5, function() thrust:Destroy() end) -- 0.5ç§’ã§åœæ­¢
                
                local con
                con = RunService.Stepped:Connect(function()
                    if not thrust.Parent then con:Disconnect() return end
                    root.CFrame = targetRoot.CFrame
                end)
            end
        end
    end
})

CombatTab:AddToggle({
    Name = "Aimbot (ã‚«ãƒ¡ãƒ©ãƒ­ãƒƒã‚¯)",
    Default = false,
    Callback = function(v) AimbotEnabled = v end
})

CombatTab:AddToggle({
    Name = "Hitbox Expander",
    Default = false,
    Callback = function(v) HitboxExpanded = v end
})

-- === Tab 4: è¦–è¦š (Visuals) ===
local VisualTab = Window:MakeTab({ Name = "ğŸ‘ï¸ è¦–è¦š", Icon = "rbxassetid://18624606749" })

local function AddESP(p)
    if p.Character and not p.Character:FindFirstChild("ESPHighlight") then
        local h = Instance.new("Highlight", p.Character)
        h.Name = "ESPHighlight"
        h.FillColor = Color3.fromRGB(255, 0, 0)
        h.OutlineColor = Color3.new(1,1,1)
    end
    if p.Character and not p.Character:FindFirstChild("NameTag") and NameESPEnabled then
        local head = p.Character:FindFirstChild("Head")
        if head then
            local bg = Instance.new("BillboardGui", head)
            bg.Name = "NameTag"
            bg.Size = UDim2.new(0,100,0,50)
            bg.StudsOffset = Vector3.new(0,2,0)
            bg.AlwaysOnTop = true
            local lab = Instance.new("TextLabel", bg)
            lab.Size = UDim2.new(1,0,1,0)
            lab.BackgroundTransparency = 1
            lab.Text = p.Name
            lab.TextColor3 = Color3.new(1,0,0)
            lab.TextStrokeTransparency = 0
        end
    end
end

VisualTab:AddToggle({
    Name = "ESP (Highlight)",
    Default = false,
    Callback = function(v)
        ESPEnabled = v
        if not v then
            for _, p in pairs(Players:GetPlayers()) do
                if p.Character and p.Character:FindFirstChild("ESPHighlight") then p.Character.ESPHighlight:Destroy() end
            end
        end
    end
})

VisualTab:AddToggle({
    Name = "Name ESP",
    Default = false,
    Callback = function(v)
        NameESPEnabled = v
        if not v then
             for _, p in pairs(Players:GetPlayers()) do
                if p.Character and p.Character:FindFirstChild("NameTag", true) then
                    for _, t in pairs(p.Character:GetDescendants()) do if t.Name == "NameTag" then t:Destroy() end end
                end
            end
        end
    end
})

VisualTab:AddToggle({
    Name = "Fullbright (æ˜åº¦)",
    Default = false,
    Callback = function(v)
        Lighting.Brightness = v and 2 or 1
        Lighting.ClockTime = v and 14 or 12
        Lighting.GlobalShadows = not v
    end
})

-- === Tab 5: ãã®ä»– (Misc) ===
local MiscTab = Window:MakeTab({ Name = "ğŸ”§ ãã®ä»–", Icon = "rbxassetid://18624616682" })

MiscTab:AddButton({
    Name = "Infinite Yield (Admin)",
    Callback = function() loadstring(game:HttpGet('https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source'))() end
})

MiscTab:AddButton({
    Name = "Dark Dex (Explorer)",
    Callback = function() loadstring(game:HttpGet("https://raw.githubusercontent.com/Babyhamsta/RBLX_Scripts/main/Universal/BypassedDarkDexV3.lua", true))() end
})

MiscTab:AddButton({
    Name = "Rejoin (å†æ¥ç¶š)",
    Callback = function() TeleportService:Teleport(game.PlaceId, localPlayer) end
})

----------------------------------------------------------
-- [System] Loop Logic (RenderStepped)
----------------------------------------------------------
OrionLib:Init()

-- ã‚¤ãƒ™ãƒ³ãƒˆæ¥ç¶š
UserInputService.JumpRequest:Connect(function()
    if InfJumpEnabled and localPlayer.Character then localPlayer.Character:FindFirstChildOfClass('Humanoid'):ChangeState("Jumping") end
end)

Players.PlayerAdded:Connect(function(p)
    p.CharacterAdded:Connect(function() task.wait(1) if ESPEnabled then AddESP(p) end end)
end)

RunService.RenderStepped:Connect(function()
    -- ESPæ›´æ–°
    if ESPEnabled or NameESPEnabled then
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= localPlayer and p.Character then AddESP(p) end
        end
    end

    -- Hitbox Expander
    if HitboxExpanded then
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= localPlayer and p.Character and p.Character:FindFirstChild("Head") then
                p.Character.Head.Size = Vector3.new(3,3,3)
                p.Character.Head.Transparency = 0.5
                p.Character.Head.CanCollide = false
            end
        end
    end
    
    -- Noclip (Player)
    if Noclip and localPlayer.Character then
        for _, part in pairs(localPlayer.Character:GetDescendants()) do
            if part:IsA("BasePart") then part.CanCollide = false end
        end
    end

    -- Aimbot
    if AimbotEnabled then
        local closest, dist = nil, math.huge
        for _, p in pairs(Players:GetPlayers()) do
            if p ~= localPlayer and p.Character and p.Character:FindFirstChild("Head") then
                local d = (p.Character.Head.Position - Camera.CFrame.Position).Magnitude
                if d < dist then dist = d closest = p end
            end
        end
        if closest then Camera.CFrame = CFrame.new(Camera.CFrame.Position, closest.Character.Head.Position) end
    end

    -- Player Fly Logic
    if PlayerFlyEnabled and localPlayer.Character then
        local root = GetRoot(localPlayer.Character)
        if root then
            if not PlayerBV then
                PlayerBV = Instance.new("BodyVelocity", root)
                PlayerBV.MaxForce = Vector3.new(1e9,1e9,1e9)
            end
            local dir = GetMoveDir()
            PlayerBV.Velocity = dir * PlayerFlySpeed
        end
    else
        if PlayerBV then PlayerBV:Destroy() PlayerBV = nil end
    end
    
    -- Train Fly Logic
    if VFlyEnabled and TargetPart and BV and BG then
        local dir = GetMoveDir()
        BV.Velocity = dir * FLY_SPEED
        
        if TrainSpinEnabled then
            BG.CFrame = BG.CFrame * CFrame.Angles(0, math.rad(SPIN_SPEED), 0)
        else
            BG.CFrame = CFrame.lookAt(TargetPart.Position, TargetPart.Position + Camera.CFrame.LookVector, Camera.CFrame.UpVector)
        end
        
        if TrainNoclipEnabled and TargetPart.Parent then
            for _, v in pairs(TargetPart.Parent:GetDescendants()) do
                if v:IsA("BasePart") then v.CanCollide = false end
            end
        end
    end
end)
